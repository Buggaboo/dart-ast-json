# dart_ast_json
Dart FFI binding generator for any LLVM Clang JSON AST dump

## Dependencies
* build_runner
* code_gen
* LLVM Clang >10.* to produce the AST-dump in JSON

## Installing clang on MacOS
```bash
brew install llvm
```

## Other great MacOS, iOS related guides
* A great post on [installing llvm](https://embeddedartistry.com/blog/2017/02/24/installing-llvm-clang-on-osx/).
* [How to get your framework dependency to run with LLVM you've just installed](https://stackoverflow.com/questions/16387484/clangllvm-compile-with-frameworks)

## Create the dumps

```bash
# dump json
clang-10 -Isomewhere/include -c main.c -o build/target.o -Xclang -ast-dump=json -fsyntax-only > project_os_arch.json

# dump record memory layout
clang-10 -Isomewhere/include -c main.c -o build/target.o -Xclang -fdump-record-layouts > project_os_arch.layout

# check for padding optimization
clang-10 -Isomewhere/include -c main.c -o build/target.o -Wpadded
```

Also useful: [`-fsave-optimization-record`](https://developer.ibm.com/linuxonpower/2018/07/02/generating-compiler-optimization-remarks-llvm/)


## Current status WIP
* Working on examples, tests and workarounds
* Waiting for the dart team to provide a [offset mechanism](https://github.com/dart-lang/sdk/issues/35763) to solve alignment/padding issues.

## Caveats
### The generated JSON will be different per ARCH and OS
Grouping commonalities between generated ARCH and OSs is still a manual task.

## Dart FFI Limitations
0. [Nested structs/unions/etc.](https://github.com/dart-lang/sdk/issues/37271#issuecomment-502946889) 
1. [Pass by value e.g. Struct/Union/Enum](https://github.com/dart-lang/sdk/issues/36730)
2. [`extern C` required for C++ code due to name mangling](https://flutter.dev/docs/development/platform-integration/c-interop#step-2-add-cc-sources)
3. [Packed structs](https://github.com/dart-lang/sdk/issues/38158)
4. [No bitfields, DIY bitmasking](https://github.com/dart-lang/sdk/issues/38954)
5. [No union](https://github.com/dart-lang/sdk/issues/38491)
6. [No support for non scalar struct fields, e.g. `int meh[2];`](https://github.com/timsneath/dart_console/blob/28f333aff8f508d10c0bf8431b54bbb813584cbd/lib/src/ffi/unix/termios.dart#L87-L127)
7. [And more...](https://github.com/dart-lang/sdk/projects/13#card-16916690)

## Workarounds
0. Each struct depends on the largest member (e.g. another struct), to determine its alignment and padding, use `-Wpadded` in clang
1. Just don't, especially for big padded structs, don't overflow the stack.
2. Just do it.
3. Clang has a `-Wpadded` that could provide clues on how to spatially optimize (instead of packing)
4. Don't. Instead use a machine word sized integer, and provide masking where necessary; explicit is better.
5. Use Struct from dart's FFI, but use a single memory location, e.g. a `Pointer<Void>` as the only field.
6. The workaround is to repeatedly state the field `@Int32 int meh_0, meh_1; // etc.` to determine the proper alignment and padding. Yuck. 

## Run program

0. Add a `build.yaml` with the necessary configuration, [see the examples](TODO)
1. Compile your C/C++ code for your ARCH and OS, with clang, and enable `-dump-ast=json`
2. Capture the JSON output in a file, `<project>_<os>_arch.json`, e.g. `miniaudio_android_arm64.py`.
Place the file generated by adding `-ast-dump=json` file in your `lib/src`.
Then run:

```bash
pub run build_runner build
```

## Struct alignment & padding

* [Alignment](https://github.com/dart-lang/sdk/blob/master/pkg/vm/lib/transformations/ffi.dart)
* [The lost art of Structure Packing](http://www.catb.org/esr/structure-packing/)
* [Padding in compilers](https://metricpanda.com/rival-fortress-update-35-avoiding-automatic-structure-padding-in-c/)

## Handy commands

Sort out types in the AST JSON:
```bash
grep desugaredQualType web/miniaudio.json | grep -v __attr | sed -e 's/^[ \t]*//' | sort | uniq | less
```

## Links
* [Pre-processor directives (macro definitions) for ARCH](https://sourceforge.net/p/predef/wiki/Architectures/)
* [Boost lib for C pre-processor directives for arch/os detection](https://www.boost.org/doc/libs/1_72_0/doc/html/predef.html)
* [Moar](https://stackoverflow.com/questions/142508/how-do-i-check-os-with-a-preprocessor-directive)

