# dart_ast_json
Dart FFI binding generator for any LLVM JSON AST dump

## Dependencies
* build_runner
* code_gen
* LLVM Clang >10.* to produce the AST-dump in JSON

## Current status WIP
* Working on examples and tests
* Waiting for the dart team to provide a [padding mechanism](https://github.com/dart-lang/sdk/issues/35763) to solve alignment issues.

## Caveats
### The generated JSON will be different per ARCH and OS
Grouping commonalities between generated ARCH and OSs is still a manual task.

## Dart FFI Limitations
0. [Nested structs/unions/etc.](https://github.com/dart-lang/sdk/issues/37271#issuecomment-502946889) 
1. [Pass by value e.g. Struct/Union/Enum](https://github.com/dart-lang/sdk/issues/36730)
2. [`extern C` required for C++ code due to name mangling](https://flutter.dev/docs/development/platform-integration/c-interop#step-2-add-cc-sources)
3. [Packed structs](https://github.com/dart-lang/sdk/issues/38158)
4. [No bitfields, DIY bitmasking](https://github.com/dart-lang/sdk/issues/38954)
5. [No union](https://github.com/dart-lang/sdk/issues/38491)
6. [No support for non scalar struct fields, e.g. `int[100][100] meh`](https://github.com/timsneath/dart_console/blob/28f333aff8f508d10c0bf8431b54bbb813584cbd/lib/src/ffi/unix/termios.dart#L87-L127)

## Workarounds
0. Each struct depends on the largest member (e.g. another struct), to determine its alignment and padding, use -Wpadded in clang
1. Just don't, especially for big padded structs, don't overflow the stack.
2. Just do it.
3. Clang has a '-Wpadded' that could provide clues on how to spatially optimize (instead of packing)
4. Don't. Instead use a machine word sized integer, and provide masking where necessary; explicit is better.
5. Use Struct from dart's FFI, but use a single memory location, e.g. a `Pointer<Void>` as the only field.
6. The workaround is to repeatedly state the field `@Int32 meh_00; @Int32 meh_01; // etc.` to determine the proper alignment and padding. Yuck. 

## Run program

1. Compile your C/C++ code for your ARCH and OS, with clang, and enable `-Wpadded -dump-ast=json`
2. Capture the JSON output in a file, `<project>_<os>_arch.json`, e.g. `miniaudio_android_arm64.py`.
Place the file generated by adding `-ast-dump=json` file in your `lib/src`.
Then run:

```bash
pub run build_runner build
```

## Struct alignment & padding

* [Aligment](https://github.com/dart-lang/sdk/blob/master/pkg/vm/lib/transformations/ffi.dart)
* [The lost art of Structure Packing](http://www.catb.org/esr/structure-packing/)
* [Padding in compilers](https://metricpanda.com/rival-fortress-update-35-avoiding-automatic-structure-padding-in-c/)

Handy commands
==============

Sort out types in the AST JSON:
```bash
grep desugaredQualType web/miniaudio.json | grep -v __attr | sed -e 's/^[ \t]*//' | sort | uniq | less
```


